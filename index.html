<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NeulinkNews | Portal Berita Video Nasional</title>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<style>
/* (CSS sama dengan kode sebelumnya) */
</style>
</head>
<body>

<header>
  <!-- Navbar sama -->
</header>

<section class="container">
<div class="headline"><h2>NeulinkNews</h2>
<p>Portal berita berbasis video dari omnichannel resmi NeulinkNews</p></div>

<div class="news-grid" id="written-news-grid"></div>

<div id="login-panel" style="display:none;">
  <h3>Login Penulis/Admin</h3>
  <form id="login-form">
    <input type="email" id="login-email" placeholder="Email" required>
    <input type="password" id="login-password" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>
</div>

<div class="cms-section" style="display:none;">
  <h3>CMS Panel</h3>
  <form id="cms-form">
    <input type="hidden" id="edit-id">
    <input type="text" id="article-title" placeholder="Judul Artikel" required>
    <select id="article-type" required>
      <option value="" disabled selected>Jenis Berita</option>
      <option value="Fakta">Fakta</option>
      <option value="Opini">Opini</option>
      <option value="Analisis">Analisis</option>
      <option value="Laporan">Laporan</option>
    </select>
    <input type="text" id="article-video" placeholder="URL Video YouTube (embed link)">
    <textarea id="article-content" placeholder="Isi Artikel" required></textarea>
    <button type="submit">Tambah / Update Berita</button>
  </form>
  <button id="logout-btn">Logout</button>
</div>

<footer>© 2025 NeulinkNews • Digital News Platform</footer>

<script>
// ===== SUPABASE CONFIG =====
const SUPABASE_URL = "https://cyaupqqfhnolidlppaoa.supabase.co";
const SUPABASE_KEY = "sb_publishable_0RFPlvRxS2VtG2WfRyRwFw_Ls0z87ll";
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const newsGrid = document.getElementById("written-news-grid");
const loginPanel = document.getElementById("login-panel");
const loginForm = document.getElementById("login-form");
const cmsPanel = document.querySelector(".cms-section");
const cmsForm = document.getElementById("cms-form");
const logoutBtn = document.getElementById("logout-btn");
const cmsNav = document.getElementById("cms-nav");
let loggedUser = null;

// ===== RENDER ARTICLES =====
async function renderArticles() {
  newsGrid.innerHTML = "";
  const { data: articles, error } = await supabase
    .from("articles")
    .select("*")
    .order("created_at", { ascending: false });

  if(error || !articles) {
    newsGrid.innerHTML = "<p style='opacity:.7'>Belum ada artikel.</p>";
    return;
  }

  articles.forEach(article => {
    const card = document.createElement("div");
    card.className = "news-card";

    let adminButtons = "";
    if(loggedUser) {
      if(loggedUser.role === "admin" || article.author === loggedUser.email) {
        adminButtons = `
          <button onclick="editArticle('${article.id}')">Edit</button>
          <button onclick="deleteArticle('${article.id}')">Hapus</button>
        `;
      }
    }

    card.innerHTML = `
      ${article.video ? `<iframe src="${article.video}" allowfullscreen></iframe>` : ""}
      <div class="news-content">
        <h3>${article.title}</h3>
        <small>${article.type} • ${article.author}</small>
        <p>${article.content.substring(0, 120)}...</p>
        <div style="margin-top:10px;display:flex;gap:5px;flex-wrap:wrap;">
          ${adminButtons}
        </div>
      </div>
    `;

    newsGrid.appendChild(card);
  });
}

// ===== CMS INSERT & UPDATE =====
cmsForm.addEventListener("submit", async e => {
  e.preventDefault();
  const editId = document.getElementById("edit-id").value;

  const articleData = {
    title: document.getElementById("article-title").value,
    type: document.getElementById("article-type").value,
    video: document.getElementById("article-video").value,
    content: document.getElementById("article-content").value,
    author: loggedUser.email
  };

  if(editId === "") {
    await supabase.from("articles").insert([articleData]);
  } else {
    await supabase.from("articles").update(articleData).eq("id", editId);
  }

  cmsForm.reset();
  document.getElementById("edit-id").value = "";
  renderArticles();
});

// ===== EDIT & DELETE =====
async function editArticle(id) {
  const { data } = await supabase.from("articles").select("*").eq("id", id).single();
  if(data){
    document.getElementById("article-title").value = data.title;
    document.getElementById("article-type").value = data.type;
    document.getElementById("article-video").value = data.video;
    document.getElementById("article-content").value = data.content;
    document.getElementById("edit-id").value = data.id;
    cmsPanel.style.display = "block";
  }
}

async function deleteArticle(id) {
  if(confirm("Apakah yakin ingin menghapus artikel ini?")) {
    await supabase.from("articles").delete().eq("id", id);
    renderArticles();
  }
}

// ===== LOGIN & LOGOUT =====
loginForm.addEventListener("submit", async e => {
  e.preventDefault();
  const email = document.getElementById("login-email").value;
  const password = document.getElementById("login-password").value;

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){ alert(error.message); return; }

  loggedUser = {
    email: data.user.email,
    role: email === "admin@neulink.com" ? "admin" : "writer"
  };

  loginPanel.style.display = "none";
  cmsPanel.style.display = "block";
  renderArticles();
});

logoutBtn.addEventListener("click", async () => {
  await supabase.auth.signOut();
  loggedUser = null;
  cmsPanel.style.display = "none";
  loginPanel.style.display = "block";
  renderArticles();
});

cmsNav.addEventListener("click", () => {
  if(loggedUser) {
    cmsPanel.style.display = cmsPanel.style.display === "none" ? "block" : "none";
    loginPanel.style.display = "none";
  } else {
    loginPanel.style.display = loginPanel.style.display === "none" ? "block" : "none";
    cmsPanel.style.display = "none";
  }
});

renderArticles();
</script>
</body>
</html>
